---
title: "Metapopulation Migration/Extinction Model"
author: Emma Ochsner and Lena Witschi
output: html_notebook
---

# Introduction

This is the code for our Model for Metapopulations in SLiM. 

## Generating Data in SLiM with Parameters from R

In this first r code block, we generate a code block (slim_code_block). This contains all the parameters we soft coded in SLiM meaning we define them first in R. After generating the code block, we send it to the terminal of the computer with the help of the system command. This runs the SLiM code and outputs all the data. 

```{r}

rm(list=ls(all=TRUE)) ## clear R environment

options(scipen = 999) ## scientific notation penalty

setwd("~/Documents/GitHub/THEE_Practical_Project/Russ")

## choose number of reps for each parameter set
reps <- 5

## Choose the different parameter values we are interested in (migration rate) and define how many repitions we want
all_m <- c(0.2,0.3,0.4)
repetition <- c(1, 2, 3, 4, 5) #do we need this?

#make a for loop for all the different values we want to test for m 
for(m in all_m){
    for(r in 1:reps){
  slim_code_block <- paste0("slim -d migration=",m," -d repetition=", r," metapop_script_basic_test.slim")
  #slim_code_block -> might not be needed...to still be tested
  system(slim_code_block)#call the code block for slim in the terminal via bash, system invokes the OS command specified by command.
}
  }


#outputs a csv file with all our data :) - (1) the mutationâ€™s id property, (2) the identifier of its mutation type, (3) its position, (4) its selection coefficient, (5) its dominance coefficient, (6) origin subpopulation identifier, (7) origin tick, and (8) prevalence.


```




## Reading out the Data and making it ready for analysis 

In this block we generate a data frame to collect all the results we want for later analysis. 

```{r}
## all SLiM output files
slim_out_files <- list.files(pattern = "slim_muts_output")
#install.packages("hierfstat")
library("hierfstat")

## make a dataframe to collect results
## each row in the dataframe corresponds to the results from a single SLiM simulation run
results_df <- data.frame(array(NA, dim = c(length(slim_out_files),13), dimnames = list(c(),c("m","reps","seed","p1", "p2", "p3", "p4", "p5", "p6", "p7", "p8", "p9", "p10"))))

## loop over all SLiM results files
for(i in 1:length(slim_out_files)){
  
  single_file <- slim_out_files[i] ## this is the name of a single SLiM result file
  
  get_the_m <- as.numeric(gsub(".*_migration =|_seed.*", "", single_file)) ## here we use gsub() to get the value of 'm' that we saved in the name of the results file
   get_the_reps <- as.numeric(gsub(".*_reps_|_migration.*", "", single_file))
  
  get_the_seed <- as.numeric(gsub(".*_seed =|\\.csv","",single_file))
  
  single_file_df <- read.csv(slim_out_files[i], sep=" ", header=F, stringsAsFactors=F) ## read the data in the SLiM results file into R
  
  ## add in column names (for the output data of SLiM)
  colnames(single_file_df) <- c("","Tick","Cycle", "T", "Deme", "mut id", "mut typ", "position on gemome", "fitness", "dominance", "original deme", "generation mut occured", "number of indiv. with mut")
  
  
  ## calculate whatever metrics you want
  ## patch p mutations -> do we need this?
   #for(p in 1:10){
    #patch_p <- single_file_df[single_file_df[,5]=="pi",]
  #}
  

  ##Create a new column with allele frequencies (Add allele freq. in a seperate row (for each file))
  #50 is K -> SO for allele freq. you have to calculate x/100 -> consider we have diploid individuals and K=50
   single_file_df$Allelefreq <- single_file_df[,13]/100
   
   
  ##calculate heterozygosity per locus (2pq -> p is allele freq and q = 1-p) (within deme)
  single_file_df$Heterozygosity_l <- 2*single_file_df[,14]*(1-single_file_df[,14])
  
  ###Next step: convert to genome wide heterozygosity (within deme)
  #na.rm = TRUE ensures that any missing values (NA) in the heterozygosity column are ignored during the calculation.
  #genomewide for the subpopulations
  for (x in 1:10){
  sel_row_p <- single_file_df[,5] == paste0("p",x)
  vektor_p_pol <- single_file_df[sel_row_p,14]
  vektor_p_0 <-rep(0,10000 - length(vektor_p_pol))
  h_p <- mean(c(vektor_p_pol,vektor_p_0), na.rm = TRUE)
  results_df[i,paste0("p",x)] <- h_p
  }
  
  #For the metapopulation -> do not need and probably also false calculation
  #vektor_pol <- c(single_file_df$Heterozygosity_l)
  #vektor_0 <- rep(0, 10000-length(vektor_pol))
  #genome_wide_heterozygosity <- mean(c(vektor_pol, vektor_0), na.rm = TRUE)
    
  results_df[i,"m"] <- get_the_m ## record the value of 'u' for this particular results file
  
  results_df[i,"reps"] <- get_the_reps ## record the value of 'r' for this particular results file
  
  results_df[i,"seed"] <- get_the_seed ## record the seed for this particular results file (this lets us keep track of individual reps of a give parameter combination), ie, maybe we did 5 reps of u=1e-8 and r=1e-8, so we will have 5 rows for these specific parameter values
  
  
}


## choose working directory
## write your results to disc
setwd("~/Documents/GitHub/THEE_Practical_Project/Russ")
write.csv(results_df, "Example_Results.csv", row.names = F)









```


